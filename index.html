<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kim & Ian: Smart Live Tracker</title>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root { --neon-blue: #00d2ff; --neon-green: #39ff14; --neon-red: #ff3131; --dark: #0a0a0a; }
        body { margin: 0; padding: 0; background: var(--dark); font-family: sans-serif; color: white; overflow: hidden; height: 100vh; }
        
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--dark); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .login-box { background: #1a1a1a; padding: 30px; border-radius: 20px; border: 1px solid #333; width: 90%; max-width: 350px; text-align: center; }
        input { width: 100%; padding: 15px; margin: 10px 0; border-radius: 10px; border: 1px solid #444; background: #000; color: var(--neon-green); font-size: 16px; outline: none; }

        #map { position: absolute; top: 0; bottom: 0; width: 100%; z-index: 1; display: none; }
        
        #dashboard { 
            position: absolute; top: 15px; left: 10px; right: 10px; z-index: 1000; 
            background: rgba(20, 20, 20, 0.9); padding: 12px; border-radius: 15px; 
            border: 2px solid #333; display: none; transition: 0.3s;
        }

        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px; }
        .stat-card { background: rgba(255,255,255,0.05); padding: 8px; border-radius: 10px; text-align: center; }
        .stat-label { font-size: 8px; color: #888; text-transform: uppercase; }
        .stat-val { font-size: 14px; font-weight: bold; color: var(--neon-blue); }

        .badge { padding: 2px 8px; border-radius: 5px; font-size: 10px; font-weight: bold; }
        .moving { background: var(--neon-green); color: black; }
        .staying { background: #555; color: white; }

        #controls { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 1000; display: none; width: 85%; }
        .btn { width: 100%; padding: 16px; border: none; border-radius: 50px; font-size: 15px; font-weight: bold; cursor: pointer; background: var(--neon-green); color: black; box-shadow: 0 4px 15px rgba(57, 255, 20, 0.3); }
        .btn-stop { background: var(--neon-red) !important; color: white; }

        /* Popup Styling */
        .leaflet-popup-content-wrapper { background: #1a1a1a; color: white; border: 1px solid var(--neon-blue); border-radius: 10px; }
        .leaflet-popup-tip { background: var(--neon-blue); }
        .popup-info { font-size: 12px; line-height: 1.6; }
        .popup-title { font-weight: bold; color: var(--neon-green); border-bottom: 1px solid #333; margin-bottom: 5px; }

        /* Smooth Icon & Animations */
        .moving-icon { animation: pulse 1s infinite alternate; filter: drop-shadow(0 0 8px var(--neon-green)); transition: all 0.5s linear; }
        @keyframes pulse { from { transform: scale(1); } to { transform: scale(1.15); } }
        
        .overspeed-alert { background: rgba(255, 49, 49, 0.8) !important; border-color: white !important; animation: bg-flash 0.5s infinite alternate; }
        @keyframes bg-flash { from { opacity: 1; } to { opacity: 0.7; } }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-box">
        <h2 style="color: var(--neon-blue);">KIM & IAN</h2>
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="pass" placeholder="Password">
        <button class="btn" onclick="doLogin()">SIGN IN</button>
    </div>
</div>

<div id="dashboard">
    <div style="display: flex; justify-content: space-between; align-items: center; font-size: 11px;">
        <div>
            <span id="role-text" style="color: var(--neon-blue); font-weight: bold;">OFFLINE</span>
            <span id="move-status" class="badge staying" style="margin-left: 5px;">STAYING</span>
        </div>
        <span id="speed-warning" style="color: white; font-weight: bold; display: none;">⚠️ OVER SPEEDING!</span>
    </div>
    <div class="stats-grid">
        <div class="stat-card"><div class="stat-label">Distance</div><div class="stat-val"><span id="distance">0.00</span> KM</div></div>
        <div class="stat-card"><div class="stat-label">Partner Speed</div><div class="stat-val"><span id="p-speed">0</span> km/h</div></div>
        <div class="stat-card"><div class="stat-label">Your Speed</div><div class="stat-val"><span id="speed">0</span> km/h</div></div>
        <div class="stat-card"><div class="stat-label">Partner Batt</div><div class="stat-val"><span id="p-batt">--</span>%</div></div>
    </div>
</div>

<div id="controls"><button id="trackBtn" class="btn" onclick="toggleTracking()">START SHARING LOCATION</button></div>
<div id="map"></div>

<audio id="alertSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>

<script>
    const SB_URL = 'https://epqvajuddzlygciadrdh.supabase.co';
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVwcXZhanVkZHpseWdjaWFkcmRoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1NTM2NDksImV4cCI6MjA4NjEyOTY0OX0.4tK1TmDQ9C0Abqood-IgFjrTCmBgVYsDAu-JPa3zYoQ';
    const supabaseClient = supabase.createClient(SB_URL, SB_KEY);

    let isTracking = false, watchId = null, userRole = null;
    let markers = {}; 
    let coords = { driver: null, partner: null };
    const SPEED_LIMIT = 60; 

    const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([7.0722, 125.601], 15);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
    L.tileLayer('https://{s}.google.com/vt/lyrs=m,traffic&x={x}&y={y}&z={z}', { maxZoom: 20, subdomains: ['mt0','mt1','mt2','mt3'], opacity: 0.8 }).addTo(map);

    const iconMotor = 'https://cdn-icons-png.flaticon.com/512/171/171240.png';
    const iconCar = 'https://cdn-icons-png.flaticon.com/512/741/741407.png';

    window.onload = () => {
        const saved = localStorage.getItem('kimian_login');
        if (saved) { userRole = JSON.parse(saved).role; showApp(); }
    };

    async function doLogin() {
        const uEmail = document.getElementById('email').value.trim();
        const uPass = document.getElementById('pass').value.trim();
        const { data } = await supabaseClient.from('my_users').select('*').eq('email', uEmail).eq('password', uPass).single();
        if (data) {
            localStorage.setItem('kimian_login', JSON.stringify(data));
            userRole = data.role; showApp();
        } else { alert("Login Error!"); }
    }

    function showApp() {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('map').style.display = 'block';
        document.getElementById('dashboard').style.display = 'block';
        document.getElementById('controls').style.display = 'block';
        document.getElementById('role-text').innerText = userRole.toUpperCase();
        document.body.addEventListener('click', () => { document.getElementById('alertSound').play().then(()=>document.getElementById('alertSound').pause()); }, { once: true });
        setTimeout(() => map.invalidateSize(), 300);
        listenUpdates();
        loadLast();
    }

    async function loadLast() {
        const { data } = await supabaseClient.from('motor_location').select('*');
        data?.forEach(loc => updateUI(loc));
    }

    function updateUI(data) {
        const { role, lat, lng, speed, battery, updated_at } = data;
        coords[role] = { lat, lng };

        const isMoving = speed > 3;
        const iconUrl = (role === 'driver') ? iconMotor : iconCar;
        const lastTime = new Date(updated_at).toLocaleTimeString();
        
        const customIcon = L.icon({ 
            iconUrl: iconUrl, 
            iconSize: [45, 45], 
            iconAnchor: [22, 22],
            className: isMoving ? 'moving-icon' : ''
        });

        const popupContent = `
            <div class="popup-info">
                <div class="popup-title">${role.toUpperCase()} INFO</div>
                <b>Status:</b> ${isMoving ? 'Moving' : 'Staying'}<br>
                <b>Speed:</b> ${speed || 0} km/h<br>
                <b>Battery:</b> ${battery || 0}%<br>
                <b>Updated:</b> ${lastTime}
            </div>
        `;

        if (!markers[role]) {
            markers[role] = L.marker([lat, lng], { icon: customIcon }).addTo(map).bindPopup(popupContent);
        } else {
            // Smooth LatLng Transition
            markers[role].setLatLng([lat, lng]);
            markers[role].setIcon(customIcon);
            markers[role].setPopupContent(popupContent);
        }

        // Distance calc
        if (coords.driver && coords.partner) {
            const R = 6371;
            const dLat = (coords.partner.lat-coords.driver.lat)*Math.PI/180;
            const dLon = (coords.partner.lng-coords.driver.lng)*Math.PI/180;
            const a = Math.sin(dLat/2)**2 + Math.cos(coords.driver.lat*Math.PI/180)*Math.cos(coords.partner.lat*Math.PI/180)*Math.sin(dLon/2)**2;
            document.getElementById('distance').innerText = (R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a))).toFixed(2);
        }

        if (role !== userRole) {
            document.getElementById('p-speed').innerText = speed || 0;
            document.getElementById('p-batt').innerText = battery || '--';
            const statusBadge = document.getElementById('move-status');
            const dash = document.getElementById('dashboard');

            if (isMoving) {
                statusBadge.innerText = "MOVING"; statusBadge.className = "badge moving";
            } else {
                statusBadge.innerText = "STAYING"; statusBadge.className = "badge staying";
            }

            if (speed > SPEED_LIMIT) {
                dash.classList.add('overspeed-alert');
                document.getElementById('speed-warning').style.display = 'block';
                document.getElementById('alertSound').play();
            } else {
                dash.classList.remove('overspeed-alert');
                document.getElementById('speed-warning').style.display = 'none';
            }
        }
    }

    function listenUpdates() {
        supabaseClient.channel('realtime').on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'motor_location' }, payload => {
            updateUI(payload.new);
        }).subscribe();
    }

    async function toggleTracking() {
        if (!isTracking) {
            isTracking = true;
            document.getElementById('trackBtn').innerText = "STOP SHARING";
            document.getElementById('trackBtn').classList.add('btn-stop');
            watchId = navigator.geolocation.watchPosition(async (pos) => {
                const { latitude, longitude, speed } = pos.coords;
                const kmh = speed ? Math.round(speed * 3.6) : 0;
                document.getElementById('speed').innerText = kmh;
                map.panTo([latitude, longitude]);
                const batt = await (navigator.getBattery ? navigator.getBattery().then(b => Math.floor(b.level * 100)) : 0);
                await supabaseClient.from('motor_location').update({ 
                    lat: latitude, lng: longitude, speed: kmh, battery: batt, updated_at: new Date().toISOString() 
                }).eq('role', userRole);
            }, null, { enableHighAccuracy: true });
        } else {
            isTracking = false;
            document.getElementById('trackBtn').innerText = "START SHARING LOCATION";
            document.getElementById('trackBtn').classList.remove('btn-stop');
            navigator.geolocation.clearWatch(watchId);
        }
    }
</script>
</body>
</html>
