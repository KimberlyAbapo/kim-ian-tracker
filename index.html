<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Kim & Ian: Supreme Tracker V8 Precision</title>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root { --neon-blue: #00d2ff; --neon-green: #39ff14; --neon-red: #ff3131; --dark: #0a0a0a; }
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        body { margin: 0; padding: 0; background: var(--dark); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; color: white; overflow: hidden; height: 100vh; width: 100vw; }
        
        #login-screen { position: fixed; inset: 0; background: var(--dark); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .login-box { background: #1a1a1a; padding: 30px; border-radius: 20px; border: 1px solid #333; width: 100%; max-width: 380px; text-align: center; box-shadow: 0 0 30px rgba(0,210,255,0.15); }
        input { width: 100%; padding: 15px; margin: 10px 0; border-radius: 12px; border: 1px solid #444; background: #000; color: var(--neon-green); font-size: 16px; outline: none; }

        #map { position: absolute; inset: 0; z-index: 1; display: none; background: #111; }
        
        #unlock-btn { 
            position: absolute; bottom: 125px; right: 20px; z-index: 2000; 
            background: var(--neon-red); color: white; border: 2px solid white; 
            width: 75px; height: 35px; border-radius: 8px; font-size: 11px; 
            cursor: pointer; display: none; align-items: center; justify-content: center; font-weight: bold; box-shadow: 0 0 15px rgba(255, 49, 49, 0.6);
        }

        #dashboard { 
            position: absolute; top: env(safe-area-inset-top, 15px); left: 10px; right: 10px; z-index: 1000; 
            background: rgba(15, 15, 15, 0.92); padding: 12px; border-radius: 18px; 
            border: 2px solid #333; display: none; backdrop-filter: blur(12px);
        }

        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .stat-card { background: rgba(255,255,255,0.04); padding: 8px; border-radius: 10px; text-align: center; border: 1px solid #222; }
        .stat-label { font-size: 9px; color: #888; text-transform: uppercase; }
        .stat-val { font-size: 15px; font-weight: bold; color: var(--neon-blue); }

        #map-type { position: absolute; top: 190px; right: 10px; z-index: 1000; background: rgba(0,0,0,0.85); border-radius: 10px; border: 1px solid #444; overflow: hidden; }
        .type-btn { background: none; border: none; color: #888; font-size: 10px; font-weight: bold; cursor: pointer; padding: 10px; }
        .type-active { color: var(--neon-blue); background: rgba(255,255,255,0.05); }

        #controls { position: absolute; bottom: calc(25px + env(safe-area-inset-bottom)); left: 50%; transform: translateX(-50%); z-index: 1000; display: none; width: 90%; max-width: 400px; }
        .btn { width: 100%; padding: 18px; border: none; border-radius: 50px; font-size: 16px; font-weight: bold; cursor: pointer; background: var(--neon-green); color: black; box-shadow: 0 5px 15px rgba(57, 255, 20, 0.2); }
        .btn-stop { background: var(--neon-red) !important; color: white; }

        .stationary-icon { animation: breathe 3s infinite ease-in-out; }
        .moving-icon { filter: drop-shadow(0 0 10px var(--neon-green)); }
        .danger-icon { animation: red-flash 0.4s infinite alternate; }

        @keyframes breathe { 0%, 100% { transform: scale(1); opacity: 0.8; } 50% { transform: scale(1.1); opacity: 1; } }
        @keyframes red-flash { from { filter: brightness(1); } to { filter: brightness(1.6) drop-shadow(0 0 15px var(--neon-red)); } }
        .overspeed-alert { background: rgba(255, 49, 49, 0.9) !important; border: 2px solid white !important; }

        .distance-label { background: var(--neon-blue); color: #000; font-weight: bold; padding: 3px 10px; border-radius: 12px; font-size: 11px; border: 2px solid #fff; white-space: nowrap; }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-box">
        <h1 style="color: var(--neon-blue); font-size: 26px;">KIM & IAN</h1>
        <p style="color: #666; font-size: 11px; margin-bottom: 25px;">SUPREME TRACKER V8 PRECISION</p>
        <input type="email" id="email" placeholder="Email Address">
        <input type="password" id="pass" placeholder="Password">
        <button class="btn" style="margin-top: 10px;" onclick="doLogin()">SIGN IN</button>
    </div>
</div>

<div id="dashboard">
    <div class="header-row">
        <div>
            <span id="role-text" style="color: var(--neon-blue); font-weight: bold; text-transform: uppercase;">OFFLINE</span>
            <span id="move-status" style="margin-left: 8px; font-weight: bold; color: #555; font-size: 11px;">STAYING</span>
        </div>
        <button onclick="doLogout()" style="background:none; border:1px solid var(--neon-red); color:var(--neon-red); font-size:10px; border-radius:5px; padding:3px 8px;">LOGOUT</button>
    </div>
    <div class="stats-grid">
        <div class="stat-card"><div class="stat-label">Distance</div><div class="stat-val" id="dist-val">0.00 km</div></div>
        <div class="stat-card"><div class="stat-label">Partner Speed</div><div class="stat-val" id="p-speed">0 km/h</div></div>
        <div class="stat-card"><div class="stat-label">Your Speed</div><div class="stat-val" id="speed-val">0 km/h</div></div>
        <div class="stat-card"><div class="stat-label">Partner Batt</div><div class="stat-val" id="p-batt">--%</div></div>
    </div>
</div>

<div id="map-type">
    <button class="type-btn type-active" id="btn-street" onclick="setMapType('street')">STREET</button>
    <button class="type-btn" id="btn-sat" onclick="setMapType('sat')">SATELLITE</button>
</div>

<button id="unlock-btn" onclick="unlockMap()">UNLOCK</button>

<div id="controls"><button id="trackBtn" class="btn" onclick="toggleTracking()">START LIVE SHARING</button></div>
<div id="map"></div>
<audio id="alertSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>

<script>
    const SB_URL = 'https://epqvajuddzlygciadrdh.supabase.co';
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVwcXZhanVkZHpseWdjaWFkcmRoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1NTM2NDksImV4cCI6MjA4NjEyOTY0OX0.4tK1TmDQ9C0Abqood-IgFjrTCmBgVYsDAu-JPa3zYoQ';
    const supabaseClient = supabase.createClient(SB_URL, SB_KEY);

    let isTracking = false, userRole = null;
    let markers = {}, connectLine = null, distLabel = null; 
    let coords = { driver: null, partner: null };
    let isMapLockedOnPartner = false;
    let isPopupOpen = false; 
    let lastVoiceAlert = 0;
    let audioUnlocked = false;
    let watchID = null;

    const streetTiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
    const satTiles = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');

    const map = L.map('map', { zoomControl: false, attributionControl: false, closePopupOnClick: false }).setView([7.0722, 125.601], 15);
    streetTiles.addTo(map);

    function setMapType(type) {
        if (type === 'sat') { map.removeLayer(streetTiles); satTiles.addTo(map); document.getElementById('btn-sat').classList.add('type-active'); document.getElementById('btn-street').classList.remove('type-active'); }
        else { map.removeLayer(satTiles); streetTiles.addTo(map); document.getElementById('btn-street').classList.add('type-active'); document.getElementById('btn-sat').classList.remove('type-active'); }
    }

    map.on('popupopen', () => isPopupOpen = true);
    map.on('popupclose', () => isPopupOpen = false);

    const iconMotor = 'https://cdn-icons-png.flaticon.com/512/171/171240.png';
    const iconCar = 'https://cdn-icons-png.flaticon.com/512/741/741407.png';

    async function doLogin() {
        if (!audioUnlocked) { window.speechSynthesis.speak(new SpeechSynthesisUtterance('')); audioUnlocked = true; }
        const email = document.getElementById('email').value.trim();
        const pass = document.getElementById('pass').value.trim();
        const { data } = await supabaseClient.from('my_users').select('*').eq('email', email).eq('password', pass).single();
        if (data) { localStorage.setItem('kimian_login', JSON.stringify(data)); userRole = data.role; showApp(); }
        else { alert("Wrong Credentials!"); }
    }

    window.onload = () => { const saved = localStorage.getItem('kimian_login'); if (saved) { userRole = JSON.parse(saved).role; showApp(); } };
    function doLogout() { if(watchID) navigator.geolocation.clearWatch(watchID); localStorage.removeItem('kimian_login'); location.reload(); }

    function showApp() {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('map').style.display = 'block';
        document.getElementById('dashboard').style.display = 'block';
        document.getElementById('controls').style.display = 'block';
        document.getElementById('role-text').innerText = userRole;
        setTimeout(() => map.invalidateSize(), 500);
        listenUpdates();
        fetchInitial();
    }

    async function fetchInitial() {
        const { data } = await supabaseClient.from('motor_location').select('*');
        data?.forEach(loc => updateUI(loc));
    }

    function unlockMap() { 
        isMapLockedOnPartner = false; 
        document.getElementById('unlock-btn').style.display = 'none'; 
        map.closePopup(); 
        if (coords[userRole]) map.flyTo([coords[userRole].lat, coords[userRole].lng], 17);
    }

    function speakAlert(msg) {
        const now = Date.now();
        if (now - lastVoiceAlert > 15000) { 
            const utter = new SpeechSynthesisUtterance(msg); utter.lang = 'en-US';
            window.speechSynthesis.speak(utter); lastVoiceAlert = now; 
        }
    }

    function updateUI(data) {
        if (!data.lat || !data.lng) return;
        const { role, lat, lng, speed, battery } = data;
        const prevCoord = coords[role];
        coords[role] = { lat, lng };

        let rotation = 0;
        if (prevCoord) { rotation = Math.atan2(lng - prevCoord.lng, lat - prevCoord.lat) * (180 / Math.PI); }

        if (role !== userRole) {
            document.getElementById('p-speed').innerText = Math.round(speed) + " km/h";
            document.getElementById('p-batt').innerText = (battery || 0) + "%";
            const moving = speed > 1;
            document.getElementById('move-status').innerText = moving ? "MOVING" : "STAYING";
            document.getElementById('move-status').style.color = moving ? "var(--neon-green)" : "#555";
            if (isMapLockedOnPartner && !isPopupOpen) map.panTo([lat, lng]);
            if (speed > 60) {
                document.getElementById('dashboard').classList.add('overspeed-alert');
                speakAlert(`Partner is speeding!`);
                document.getElementById('alertSound').play().catch(()=>{});
            } else { document.getElementById('dashboard').classList.remove('overspeed-alert'); }
        } else {
            if (!isMapLockedOnPartner && isTracking && !isPopupOpen) map.panTo([lat, lng]);
        }

        let anim = (speed > 60) ? 'danger-icon' : (speed > 1 ? 'moving-icon' : 'stationary-icon');
        const customIcon = L.divIcon({
            className: 'custom-marker',
            html: `<div class="${anim}" style="width:42px; height:42px;">
                     <img src="${role==='driver'?iconMotor:iconCar}" style="width:100%; height:100%; transform: rotate(${rotation}deg); transition: transform 0.5s linear;">
                   </div>`,
            iconSize: [42, 42], iconAnchor: [21, 21]
        });

        if (!markers[role]) {
            markers[role] = L.marker([lat, lng], { icon: customIcon }).addTo(map).bindPopup(`<b>${role}</b><br>âš¡ ${speed}km/h | ðŸ”‹ ${battery}%`);
            markers[role].on('click', () => { 
                if (role !== userRole) { 
                    isMapLockedOnPartner = true; 
                    document.getElementById('unlock-btn').style.display = 'flex'; 
                    map.flyTo([lat, lng], 17);
                } else { unlockMap(); }
            });
        } else { markers[role].setLatLng([lat, lng]).setIcon(customIcon); }

        if (coords.driver && coords.partner) {
            const p1 = [coords.driver.lat, coords.driver.lng], p2 = [coords.partner.lat, coords.partner.lng];
            if (!connectLine) connectLine = L.polyline([p1, p2], { color: 'var(--neon-blue)', weight: 2, dashArray: '8, 12' }).addTo(map);
            else connectLine.setLatLngs([p1, p2]);
            const dist = (map.distance(p1, p2) / 1000).toFixed(2);
            document.getElementById('dist-val').innerText = dist + " km";
            const mid = [(p1[0]+p2[0])/2, (p1[1]+p2[1])/2];
            if (!distLabel) distLabel = L.marker(mid, { icon: L.divIcon({ className: 'distance-label', html: dist + " km" }) }).addTo(map);
            else { distLabel.setLatLng(mid); distLabel.setIcon(L.divIcon({ className: 'distance-label', html: dist + " km" })); }
        }
    }

    function listenUpdates() { supabaseClient.channel('track').on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'motor_location' }, p => updateUI(p.new)).subscribe(); }

    async function toggleTracking() {
        if (!isTracking) {
            isTracking = true;
            document.getElementById('trackBtn').innerText = "STOP SHARING";
            document.getElementById('trackBtn').classList.add('btn-stop');

            // (8) PRECISION TRACKING: watchPosition forces high frequency updates
            watchID = navigator.geolocation.watchPosition(async (pos) => {
                const { latitude, longitude, speed } = pos.coords;
                const kmh = speed ? Math.round(speed * 3.6) : 0;
                document.getElementById('speed-val').innerText = kmh + " km/h";
                
                let bLevel = 0; 
                try { 
                    const bat = await navigator.getBattery(); 
                    bLevel = Math.floor(bat.level * 100); 
                } catch(e) { bLevel = 100; }

                await supabaseClient.from('motor_location').update({ 
                    lat: latitude, 
                    lng: longitude, 
                    speed: kmh, 
                    battery: bLevel, 
                    updated_at: new Date().toISOString() 
                }).eq('role', userRole);

            }, (err) => console.error(err), { 
                enableHighAccuracy: true, 
                maximumAge: 0, 
                timeout: 5000 
            });

            // Focus on self at start
            navigator.geolocation.getCurrentPosition(p => map.flyTo([p.coords.latitude, p.coords.longitude], 17));

        } else { location.reload(); }
    }
</script>
</body>
</html>
